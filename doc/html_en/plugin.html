<!DOCTYPE html>
<html lang="ja-JP">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>OpenNovel</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    code { background-color: #CF9; }
  </style>
</head>
<body>

<h1>Plugin Script</h1>

<h2>About Plugin Script</h2>
<p>
  <code>OpenNovel</code> story scripts focus on how ordinary stories flow,
  they are incapable of handling complex logic projects.
  Plugin script should be used for such purposes.
</p>
<p>
  Plugin script is available for a complex logic.
  Calling a plugin script from a story script makes it possible to write complex logic.
</p>

<h2>Basics</h2>
<p>
  A script to change a color of a message box is the following.
</p>
<pre><code>func main() {
    onvl_set_config("msgbox.font.r", "128");
    onvl_set_config("msgbox.font.g", "128");
    onvl_set_config("msgbox.font.b", "128");
}</code></pre>

<p>
  Use this script from <code>story.txt</code>.
</p>
<pre><code>We will change the color.
@plugin change-color.txt
The color was changed.</code></pre>

<h2>Syntax</h2>

<h3>A program start from <code>main()</code> function</h3>
<pre><code>func main() {
    // This is a comment.
    print("Hello, world!");
}</code></pre>

<h3>A function can call other functions</h3>
<pre><code>func main() {
    foo(0, 1, 2);
}

func foo(a, b, c) {
    return a + b + c;
}</code></pre>

<h3>Indirect call is possible via a string variable</h3>
<pre><code>func main() {
    myfunc = "foo";
    myfunc(0, 1, 2);
}

func foo(a, b, c) {
    return a + b + c;
}

func myfunc(a, b, c) {
    // This function will not be called. foo() will be called instead.
}</code></pre>


<h3>Types and Variables</h3>
<p>
  A program can use integer, floating point, string, or array variables.
</p>
<pre><code>func main() {
    // Integer
    a = 1;
    if(isint(a)) {
        print("a is int");
    }

    // Floating-point
    b = 1.0;
    if(isfloat(b)) {
        print("b is float");
    }

    // String
    c = "string";
    if(isstr(c)) {
        print("c is string");
    }

    // Array (with integer index)
    d[0] = 0;
    if(isarray(d)) {
        print("d is array");
    }

    // Array (with string index)
    e["abc"] = 0;
    if(isarray(e)) {
        print("e is array");
    }

    // Array of array
    f["key"] = e;
}</code></pre>

<h3>Calculation</h3>
<p>
  Integer and floating point values can be added, subtracted, multiplied, or divided.
</p>
<p>
  For integers:
</p>
<pre><code>a = 1;
b = 2;
c = a + b;
// a += b; form is not supported.</code></pre>
<p>
  For floating-points:
</p>
<pre><code>a = 1.0;
b = 2.0;
c = a + b;</code></pre>
<p>
  For integer and floating-point:
</p>
<pre><code>a = 1;
b = 2.0;
c = a + b; // c is floating-point (promoted)</code></pre>
<p>
  For integer reminder:
</p>
<pre><code>a = 3;
b = a % 2; // The result is the reminder of 3/2, i.e., 1</code></pre>
<p>
  Strings can be concatenated by a plus operator:
</p>
<pre><code>a = "aaa";
b = "bbb";
c = a + b;</code></pre>
<p>
  A string + an integer will be a string, but an integer + a string will be an integer.
</p>

<h3>For loop with a simple counter</h3>
<p>
  Repeats for the specified count:
</p>
<pre><code>func main() {
    for(i in 0..9) {
        print(i);
    }
}</code></pre>

<h3>Repeat for each array element:</h3>
<pre><code>func main() {
    a[0] = 0;
    a[1] = 1;
    a[2] = 2;
    for(v in a) {
        print(v);
    }
}</code></pre>

<h3>Repeat for each array key-value pair:</h3>
<pre><code>func main() {
    a["key1"] = 0;
    a["key2"] = 1;
    a["key3"] = 2;

    for(k, v in a) {
        print(k + "=" + v);
    }
}</code></pre>

<h3>Simple "while" loop:</h3>
<pre><code>func main() {
    a = 10;
    while (a &gt; 0) {
        print(a);
        a = a - 1;
    }
}</code></pre>

<h3>break and continue:</h3>
<pre><code>func main() {
    for(i in 0..9) {
        if(i == 2) {
            continue;
        }
        if(i == 7) {
            break;
        }
    }
}</code></pre>

<h3>Branches</h3>
<p>
  if - else if - else
</p>
<pre><code>func main() {
    a = foo();
    if(a &gt; 10) {
        print("a &gt; 10");
    } else if(a &gt; 5) {
        print("a &gt; 5");
    } else {
        print("else");
    }
}

func foo() {
    return 6;
}</code></pre>

<h3>Array</h3>
<p>
  An array element has a key (index), and key can be one of these: integer, floating point, or string type.
  Elements can have different key types in an array.
</p>
<p>
  To make an array, assign a value to a variable by [key] syntax.
</p>
<pre><code>func main() {
    a[0] = 0;
    print(a);
}</code></pre>
<p>
  To remove an array element, use remove().
</p>
<pre><code>func main() {
    a[0] = 0;
    remove(a, 0);
    print(a);
}</code></pre>
<p>
  You can use "size()" to get the number of array elements.
</p>
<pre><code>func main() {
    a[0] = 0;
    print(size(a));
}</code></pre>

<h3>Type Conversion</h3>
<p>
  Integer to string:
</p>
<pre><code>s = "" + 123;</code></pre>
<p>
  Floating point to string:
</p>
<pre><code>s = "" + 1.23;</code></pre>
<p>
  Integer to floating point:
</p>
<pre><code>f = 0.0 + 123;</code></pre>
<p>
  String to integer:
</p>
<pre><code>i = 0 + "123";</code></pre>
<p>
  String to floating point:
</p>
<pre><code>f = 0.0 + "1.23";</code></pre>
<p>
  That's all about the grammer.
</p>

<h2>Calling OpenNovel Engine</h2>
<p>
  Main game engine provides some functions to the plugin language.
  Those functions have the onvl_ prefix in their names.
</p>

<h3>Getting a flag variable</h3>
<p>
  <code>onvl_get_variable()</code> is a function to get a flag value.
</p>
<pre><code>value = onvl_get_variable(100);</code></pre>

<h3>Setting a flag value</h3>
<p>
  <code>onvl_set_variable()</code> is a function to set a flag value.
</p>
<pre><code>onvl_set_variable(100, 1);</code></pre>

<h3>Getting a random number</h3>
<p>
  <code>onvl_random()</code> returns a random number between <code>0</code> and <code>9999</code>.
</p>
<pre><code>value = onvl_random();</code></pre>

<h3>Overwriting a config</h3>
<p>
  <code>onvl_set_config()</code> overwrites a config.
</p>
<pre><code>onvl_set_config("msgbox.x", "0");
onvl_set_config("msgbox.speed", "20.0");
</code></pre>

<hr>

<h1 id="-">Usage</h1>
<p>
  Please test the following examples.
</p>

<h2>Get a flag variable value, calculate, then write back a flag</h2>
<pre><code>func main() {
    // Get variable values.
    a = onvl_get_variable(0);
    b = onvl_get_variable(1);
    c = onvl_get_variable(2);

    // Calc the sum.
    sum = a + b + c;

    // Write to $100.
    onvl_set_variable(100, sum);
}</code></pre>

<h2>Getting real calendar date</h2>
<p>
  get-datetime.txt
</p>
<pre><code>func main() {
    // Get date.
    now_y = onvl_get_year();
    now_mo = onvl_get_month();
    now_d = onvl_get_day();
    now_h = onvl_get_hour();
    now_mi = onvl_get_minute();
    now_s = onvl_get_second();
    now_w = onvl_get_wday(); // 0=Sun

    // Write back.
    onvl_set_variable(1, now_mo);
    onvl_set_variable(2, now_d);
}</code></pre>
<p>
  In a story file:
</p>
<pre><code>@plugin get-datetime.txt

@if $1 == 4 on_april
@goto not_birthday

:on_april
@if $2 == 14 birthday
@goto not_birthday

:birthday
Happy birthday!
@goto common

:not_birthday
Regular date.

:common
# Common</code></pre>

</body>
</html>
